"""FCBot Runner Script.

Generated by FCBot from Configuration File at:
{{ config_filename }}
"""

import json
import logging
import os
import signal
import sys
import tempfile
import time

from PySide2 import QtCore

{% if extra_sys_paths %}
{%- for path in extra_sys_paths -%}
sys.path.append({{ path | quote }})
{% endfor %}
{% endif -%}

from fcbot.logging import init_logging
from fcbot.outputs import load_runner_json

logger = init_logging({{ logging_level | default('INFO') | quote }})
logger.info(f'FCBot Run Script Started from {__file__}')


try:
    import FreeCAD
    import FreeCADGui
except ModuleNotFoundError:
    logger.error('This script must be run from within FreeCAD')
    sys.exit(1)
except ImportError:
    logger.error('This script must be run in FreeCAD GUI mode')
    sys.exit(1)


input_fn = {{ input_filename | quote }}
try:
    logger.info(f'Opening input file {input_fn}')
    doc = FreeCAD.open(input_fn)

except Exception:
    logger.error(f'Could not open input file {input_fn}')
    FreeCADGui.getMainWindow().close()
    sys.exit()


try:
    outputs = [{% for output in outputs %}
        {{ output.emit(output_dir) }},
{%- endfor %}
    ]

    for output in outputs:
        output.run(doc)

except Exception as exc:
    logger.error(f'Failed processing {input_fn}: {repr(exc)}')

# Force quit so that FreeCAD doesn't hang on Save Changes dialog
os.kill(os.getpid(), signal.SIGTERM)
